# Code Audit 報告

**審查時間**: 2026-01-20
**審查範圍**: ClaudeSetup 專案（全專案）
**檔案數量**: 7 個主要檔案

---

## 問題總覽

| 等級 | 數量 |
|------|------|
| Critical | 1 |
| Warning | 5 |
| Info | 4 |

---

## Critical 問題

### 1. 硬編碼的檔案路徑可能導致設定失效

- **位置**: `configs/claude/settings.json:10-13`
- **問題**: MCP server 設定包含 Windows 特定的硬編碼路徑 `C:\Users\Yuru Hung\Desktop\Project\數位分身`
- **影響**: 當此設定檔被部署到其他電腦時：
  1. 路徑不存在，MCP server 無法啟動
  2. 使用者名稱不同，路徑完全失效
  3. macOS 用戶完全無法使用此設定
- **建議**:
  - 將此路徑改為相對路徑或使用環境變數
  - 或在 README 中明確說明需要手動修改
  - 或建立一個 `settings.json.template`，移除 MCP 設定

```json
// 問題程式碼
"cwd": "C:\\Users\\Yuru Hung\\Desktop\\Project\\數位分身",
"env": {
  "PYTHONPATH": "C:\\Users\\Yuru Hung\\Desktop\\Project\\數位分身"
}
```

---

## Warning 問題

### 1. install.sh 環境變數設定可能造成副作用

- **位置**: `scripts/install.sh:127-132`
- **問題**: 使用 `set -a` / `set +a` 會將 `.env.master` 中的所有變數自動 export，可能洩漏敏感變數給所有子程序
- **建議**: 改用更明確的 export 方式，或加上註解提醒用戶

```bash
# 問題程式碼
echo "set -a" >> "$ZSHRC"
echo "source \"$ENV_MASTER\"" >> "$ZSHRC"
echo "set +a" >> "$ZSHRC"
```

### 2. install.sh 缺少錯誤處理的 Homebrew 安裝

- **位置**: `scripts/install.sh:43-48`
- **問題**: Homebrew 安裝使用 `curl -fsSL` 下載並執行遠端腳本，如果網路問題或腳本被篡改，可能有安全風險
- **建議**:
  - 加入 SHA 校驗
  - 或提供離線安裝選項
  - 至少加上網路錯誤處理

### 3. setup.ps1 步驟編號錯誤

- **位置**: `setup.ps1:105`
- **問題**: 寫著 `[Step 5/4]`，步驟總數計算錯誤，造成混淆
- **建議**: 修正為 `[Step 5/5]` 或調整步驟編號

```powershell
# 問題程式碼
Write-Host "[Step 5/4] Installing Claude Code CLI..." -ForegroundColor Cyan
```

### 4. export.ps1 沒有 -Force 參數時的重複匯出問題

- **位置**: `scripts/export.ps1:56-63`
- **問題**: commands 和 skills 目錄的複製沒有 -Force 檢查邏輯，但 settings.json 有。不一致的行為可能讓用戶混淆
- **建議**: 統一行為，要嘛全部都檢查，要嘛都不檢查

### 5. .env.example 包含假的 API Key 格式

- **位置**: `.env.example:6`
- **問題**: `ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxxxxx` 格式看起來像真的 key
- **建議**: 使用更明顯的佔位符如 `YOUR_API_KEY_HERE`

---

## Info 建議

### 1. PowerShell 腳本缺少 help 參數支援

- **位置**: `scripts/install.ps1`, `scripts/export.ps1`
- **建議**: 加入 `-Help` 或 `-?` 參數，顯示使用說明

### 2. install.sh 的 APP 安裝錯誤處理太寬鬆

- **位置**: `scripts/install.sh:74`
- **建議**: `2>/dev/null || echo "(skipped or already installed)"` 會隱藏真正的錯誤訊息，考慮更詳細的錯誤處理

### 3. mac.txt 註解行格式不一致

- **位置**: `apps/mac.txt`
- **建議**: 部分註解用 `#` 開頭，部分有空格，建議統一格式

### 4. 缺少安裝後驗證腳本

- **位置**: N/A
- **建議**: 根據 PRD，有規劃「驗證腳本」但尚未實作，建議加入 `verify.ps1` / `verify.sh`

---

## 總結

### 整體評價

程式碼品質整體良好，結構清晰，註解充分。主要問題集中在跨平台相容性（硬編碼路徑）和一些細節不一致的地方。

### 優先處理建議

1. **Critical**: 修正 `settings.json` 中的硬編碼路徑問題
2. **Warning**: 修正 `setup.ps1` 的步驟編號
3. **Warning**: 統一 `export.ps1` 的 -Force 行為

### 做得好的地方

1. **錯誤處理完善**: PowerShell 腳本使用 `$ErrorActionPreference = "Stop"`
2. **備份機制**: install 腳本會自動備份現有設定
3. **跨平台支援**: 同時提供 Windows (ps1) 和 macOS (sh) 腳本
4. **顏色輸出**: 使用顏色區分不同類型的訊息，使用者體驗好
5. **文件完整**: README、CLAUDE.md 說明清楚
6. **.gitignore 完善**: 正確排除敏感檔案和快取目錄
7. **模組化設計**: 腳本功能分離清楚（install / export / setup）
